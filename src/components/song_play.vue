<template>
    <div>
      <footer>
        <div class="img">
          <img src="314601.jpg" alt="">
        </div>
        <div class="control">
        <span id="pre">
            <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2421"><path d="M448 512 896 960 896 64ZM128 64l256 0 0 896-256 0 0-896Z" p-id="2422"></path></svg>
        </span>
          <span id="play">
            <span><svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5608"><path d="M128.171284 965.968936V57.574307C128.171284 15.992863 166.554155-15.992863 201.738454 9.595718c28.787154 19.191436 617.324519 419.013015 668.501681 454.197314 31.985726 22.390008 31.985726 76.765743 0 99.155752-35.184299 25.588581-626.920237 425.410161-671.700253 454.197315-28.787154 19.191436-70.368598-3.198573-70.368598-51.177163z" p-id="5609"></path></svg></span>
            <span style="display: none"><svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5689"><path d="M128.000251 109.567928C128.000251 49.087968 176.640219 0 237.696179 0 298.30414 0 347.520108 49.407968 347.520108 109.567928V914.429402A109.439928 109.439928 0 0 1 237.696179 1023.99933 109.887928 109.887928 0 0 1 128.000251 914.430402V109.567928z m548.543641 0C676.543892 49.087968 725.24786 0 786.303821 0 846.847781 0 895.999749 49.407968 895.999749 109.567928V914.429402A109.439928 109.439928 0 0 1 786.303821 1023.99933a109.887928 109.887928 0 0 1-109.759929-109.567928V109.567928z" fill="" p-id="5690"></path></svg></span>
        </span>
          <span id="next">
            <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5002"><path d="M576 512 128 960 128 64ZM640 64l256 0 0 896-256 0 0-896Z" p-id="5003"></path></svg>
        </span>
        </div>
        <div class="current">
          <h3>---</h3>
          <div><p><span></span></p></div>
          <p class="time"><span>00:00</span><span>/00:00</span></p>
        </div>
        <div class="li">
          <!--<div class="volume"><div><p><span></span></p></div></div>-->
          <span>
<svg class="icon" style="width: 1em;height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;color: #fff;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6567"><path d="M823.296 772.608c-17.92-17.92-17.92-41.472 0-59.392 114.688-113.152 114.688-291.328 0-404.48-17.92-17.92-17.92-41.472 0-59.392s42.496-17.92 60.416 0c72.192 71.68 114.688 160.768 114.688 256s-42.496 190.464-114.688 255.488c-6.144 6.144-17.92 11.776-30.208 11.776-12.288 12.288-24.064 6.144-30.208 0z m-120.832-65.024c-12.288 0-24.064-6.144-30.208-11.776-17.92-17.92-17.92-41.472 0-59.392 72.704-71.168 72.704-178.176 0-249.856-17.92-17.92-17.92-41.472 0-59.392s42.496-17.92 60.416 0c108.544 100.864 108.544 261.632 0 362.496-12.288 11.776-18.432 17.92-30.208 17.92zM478.72 94.72c54.272-41.472 96.768-17.92 96.768 47.616V885.76c0 65.536-42.496 83.456-90.624 41.472l-217.6-178.176H146.432c-66.56 0-120.832-53.76-120.832-118.784V386.048c0-65.536 54.272-118.784 120.832-118.784H261.12l217.6-172.544z" p-id="6568"></path></svg>        </span>
          <span style="display: none">
        <svg class="icon" style="width: 1em;height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;color: #fff;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6662"><path d="M944 512c0-191.872-123.008-289.792-128.256-293.888-20.736-16.256-50.624-12.48-67.008 8.256C732.416 247.04 736 277.12 756.544 293.632 760.256 296.64 848 368.64 848 512c0 117.76-58.496 186.496-81.536 209.216l-49.408-49.408c22.528-30.976 44.096-75.904 44.096-135.232 0-121.856-90.624-183.744-94.528-186.304-21.888-14.592-51.2-8.768-65.984 12.992C585.728 384.896 591.36 414.656 612.928 429.76c2.112 1.472 52.16 37.376 52.16 106.752 0 27.328-7.808 49.216-17.344 65.984L512 466.752 512 64 310.656 265.344l-160-160L105.344 150.656l160 160L256 320 64 320l0 384 192 0 256 256L512 557.248l93.504 93.504c-14.72 15.872-17.984 39.872-5.44 58.624 9.344 13.888 24.448 21.376 39.936 21.376 9.216 0 18.496-2.624 26.624-8.064 0.512-0.384 2.88-2.048 6.208-4.608l71.744 71.744c1.344 2.56 1.984 5.312 3.84 7.68 4.864 6.272 11.072 10.816 17.792 13.952l107.2 107.2 45.248-45.248-84.416-84.416C869.568 753.728 944 662.016 944 512z" p-id="6663"></path></svg>
    </span>
        </div>
      </footer>
    </div>
</template>

<script>
export default {
  name: 'song_play',
  data () {
    return {
      url: 'http://ruidong.cloudno.de',
      id: this.$route.params.id,
      src: '',
      audio: '',
      song_name: '',
      img: '',
      timelength: '',
      ch: null,
      end: '',
      state: 0
    }
  },
  beforeDestroy: function () {
    clearInterval(this.ch)
  },
  methods: {
    // 转换时间
    tim: function (date) {
      let min = parseInt(date / 60)
      if (min < 10) min = '0' + min
      let s = parseInt(date % 60)
      if (s < 10) s = '0' + s
      let ti = min + ':' + s
      return ti
    },
    rotate: function (img) {
      $('.img>img').attr('src', img)
      if (this.end && !this.audio.paused) {
        //  setInterval(()=>{
        this.iii += 20
        $('.img>img').css('transform', 'rotate(' + this.iii + 'deg)')
        // },1000)
      } else if (!this.end) {
        this.iii = 0
      }
    },
    // 播放器控制
    control: function () {
      let that = this
      let timelength
      let img
      $.ajax({
        url: that.url + '/song/detail?ids=' + that.id,
        type: 'GET',
        async: false,
        success: function (data) {
          console.log(data.songs[0])
          timelength = parseInt(data.songs[0].dt / 1000)
          that.song_name = data.songs[0].name
          img = data.songs[0].al.picUrl
        }
      })
      $('.current>h3').html(that.song_name)
      // 进度条
      // console.log(that.ch)
      if (!this.audio.paused) {
        // console.log(this.audio.duration)
        $('#play>span').hide()
        $('#play>span:last-child').show()
        that.ch = setInterval(() => {
          if (that.audio.ended) {
            $('.current').unbind()
            $('.current>div>p>span').unbind()
            $('.current>div').unbind()
            clearInterval(that.ch)
            that.end = 0
          } else {
            let now = that.audio.currentTime
            let len = now / timelength
            len = len * 100
            // console.log(timelength);
            $('.current>div>p').css('width', len + '%')
            $('.time>span:first-child').html(that.tim(now))
            that.rotate(img)
            that.end = 1
          }
        }, 1000)
        for (let i = 0; i < 100; i++) {
          if (that.ch == i) { continue }
          // clearInterval(i);
        }
        $('.time>span:last-child').html('/' + that.tim(timelength))
        $('.current').mousemove((e) => {
          e.preventDefault()
          if (that.state) {
            let left = parseInt($('div.img').width()) + parseInt($('div.control').width())

            left = e.screenX - left
            let p_height = parseInt($('.current>div').width())
            left = left / p_height
            $('.current>div>p').css('width', left * 100 + '%')
            that.audio.currentTime = left * timelength
          }
        }).mouseup(() => {
          that.state = 0
        })
        $('.current>div>p>span').mousedown((e) => {
          e.preventDefault()
          that.state = 1
        })
        $('.current>div').click((e) => {
          let wid = parseInt($('div.img').width())
          if (isNaN(wid)) wid = 0
          let left = wid + parseInt($('div.control').width())
          left = e.clientX - left
          let p_height = parseInt($('.current>div').width())
          left = left / p_height
          $('.current>div>p').css('width', left * 100 + '%')
          that.audio.currentTime = left * timelength
        })
      } else {
        $('#play>span').hide()
        $('#play>span:first-child').show()
      }
      ;
      // 播放按钮组
      $('#play').click(function () {
        if (that.audio.paused) {
          that.audio.play()
          $('#play>span').hide()
          $('#play>span:last-child').show()
        } else {
          // console.log(that.audio);
          that.audio.pause()
          $('#play>span').hide()
          $('#play>span:first-child').show()
        }
      })
      // 上一曲
      document.getElementById('pre').onclick = function () {
        // that.prev(this);
        alert('该功能暂未实现，敬请期待！')
      }
      // 下一曲
      document.getElementById('next').onclick = function () {
        // that.next(this);
        alert('该功能暂未实现，敬请期待！')
      }
    }
  },
  mounted: function () {
    let that = this
    new Promise((resolve, reject) => {
      resolve(`http://music.163.com/song/media/outer/url?id=${that.id}.mp3`)
    }).then(function (src) {
      $('audio').remove()
      that.audio = null
      that.audio = new Audio(src)
      $('footer').append(that.audio)
      that.audio.play()
      that.control()
    })
  }
}
</script>

<style scoped>
@import "../assets/song_play.css";
</style>
